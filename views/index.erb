<html>
	<head>
		<title>
			Super Silly Twitter App
		</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
		<style>
		.tweet {
			float: left;
			width: 100%;
		}
		#tweets {
			width: 973px;
			float: left;
			height: 73px;
		}
		.prof {
			float: left;
			width: 73;
		}
		#tweets p {
			float: left;
			width: 900px;
			height: 73px;
		}
		.pic {
			width: 300px;
			float: left;
		}
		</style>
	</head>
	<body>
		<script type="text/javascript">
		var USE_SEARCH_API = false;

		function printTweet(avatar, photo_url, from_user, text) {
			var div = $("<div/>").addClass('tweet').appendTo("#tweets");
			$("<img/>").addClass('prof').attr("src", avatar).appendTo(div);
			if (photo_url != '')
				$('<img/>').addClass('pic').attr("src", photo_url).appendTo(div);
			$("<p/>").html(from_user + ': ' + text).appendTo(div);		
		}
		function getPhotoUrl(entities) {
			var photo_url = '';
			if (entities.media && entities.media.length > 0) {
				photo_url = entities.media[0].media_url;
			} else if (entities.urls.length > 0) { // check others
				if (entities.urls[0].expanded_url.indexOf('instagr') != -1) {
				  photo_url = entities.urls[0].expanded_url + 'media/?size=l';
				}
			}
			return photo_url;			
		}

		function parseSearch(data) {

			$.each(data.results, function(i, tweet){
				var profile_img = tweet.profile_image_url.replace('normal', 'bigger');	
				var photo_url = getPhotoUrl(tweet.entities);
				printTweet(profile_img, photo_url, tweet.from_user, tweet.text);
			});
		}

		function parseStream(data) {

			$.each(data, function(i, tweet){
				var profile_img = tweet.user.profile_image_url.replace('normal', 'bigger');
				var photo_url = getPhotoUrl(tweet.entities);
				printTweet(profile_img, photo_url, tweet.user.name, tweet.text);
			});
		}

		function fetchTweets() {
			if (USE_SEARCH_API) {
				$.getJSON("http://search.twitter.com/search.json?callback=?",
					{
					q: "#barcelona",
					include_entities: 1,
					result_type: "recent"
					}, parseSearch
				);
			} else {
				$.getJSON("http://localhost:9292/search", parseStream);
			}
		}
		setInterval(fetchTweets, 2 * 1000);
		</script>
		<div id="tweets"></div>
	</body>
</html>